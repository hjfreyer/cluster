#cloud-config

ssh_authorized_keys:
  - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCaX2jEcW7VrVXQLAWkhuXn0Q54x4DWSmPIYdTrGfvEgzveUDbt8firnsa6a9nkWsRqfhOLncRy/r4/PhV4i70EmqjHF9g7FkGN7M7a6KYLl61o2cqsrQ8YZA80S8frJNYgC/O9yGvZTkbjT5JKdFINY8IZp8SYBgSdL/vbxRxvOqk2APBNfyuwlhshE31Yqka54+bQHa20lUW9BQpWyM6d9Bht/Yys3yVq18KyhzVLuWDOXlcAfoqZBlG57D7zIDZ0l230VjRxdJQRkv31Od81+dqZV873cGmvLgEFHl3v1jGgCWbVcx0RZ6VZqvqBF1el+Nad4HhbiMka9k2/qgSV hjfreyer@church"

coreos:
  units:
    - name: data.mount
      command: start
      content: |
        [Mount]
        What=/dev/disk/by-uuid/8cb79d79-7a82-4263-98fb-192d6311618a
        Where=/data/
        Type=ext4
    - name: mnt-blockchain.mount
      command: start
      content: |
        [Mount]
        What=/dev/disk/by-uuid/9027dd4b-ae81-4308-934a-3671d82619ab
        Where=/mnt/blockchain/
        Type=ext4

    - name: kubelet.service
      command: start
      enable: true
      content: |
        [Unit]
        Description=Kubernetes Kubelet
        Documentation=https://github.com/kubernetes/kubernetes

        [Service]
        ExecStartPre=/usr/bin/mkdir -p /etc/kubernetes/manifests
        ExecStart=/usr/bin/kubelet \
          --api-servers=http://127.0.0.1:8080 \
          --allow-privileged=true \
          --config=/etc/kubernetes/manifests \
          --v=2
        Restart=on-failure
        RestartSec=5

        [Install]
        WantedBy=multi-user.target
write_files:
  - path: '/etc/kubernetes/manifests/kubernetes.yaml'
    content: |      
      apiVersion: v1
      kind: Pod
      metadata: 
        name: kube-controller
      spec: 
        hostNetwork: true
        volumes:
          - name: "etc-kubernetes"
            hostPath:
              path: "/etc/kubernetes"
          - name: "ssl-certs"
            hostPath:
              path: "/usr/share/ca-certificates"
          - name: "var-run-kubernetes"
            hostPath:
              path: "/var/run/kubernetes"
          - name: "etcd-datadir"
            hostPath:
              path: "/var/lib/etcd"
          - name: "usr"
            hostPath:
              path: "/usr"
          - name: "lib64"
            hostPath:
              path: "/lib64"
        containers: 
          - name: "etcd"
            image: "b.gcr.io/kuar/etcd:2.1.1"
            args: 
              - "--data-dir=/var/lib/etcd"
              - "--advertise-client-urls=http://127.0.0.1:2379"
              - "--listen-client-urls=http://127.0.0.1:2379"
              - "--listen-peer-urls=http://127.0.0.1:2380"
              - "--name=etcd"
            volumeMounts:
              - mountPath: /var/lib/etcd
                name: "etcd-datadir"
          - name: "kube-apiserver"
            image: "b.gcr.io/kuar/kube-apiserver:1.2.0"
            args: 
              - "--allow-privileged=true"
              - "--etcd-servers=http://127.0.0.1:2379"
              - "--insecure-bind-address=0.0.0.0"
              - "--service-cluster-ip-range=10.200.20.0/24"
              - "--v=2"
            volumeMounts:
              - mountPath: /etc/kubernetes
                name: "etc-kubernetes"
              - mountPath: /var/run/kubernetes
                name: "var-run-kubernetes"
          - name: "kube-controller-manager"
            image: "b.gcr.io/kuar/kube-controller-manager:1.2.0"
            args: 
              - "--master=http://127.0.0.1:8080"
              - "--v=2"
          - name: "kube-scheduler"
            image: "b.gcr.io/kuar/kube-scheduler:1.2.0"
            args:
              - "--master=http://127.0.0.1:8080"
              - "--v=2"
          - name: "kube-proxy"
            image: "b.gcr.io/kuar/kube-proxy:1.2.0"
            args:
              - "--master=http://127.0.0.1:8080"
              - "--v=2"
            securityContext:
              privileged: true
            volumeMounts:
              - mountPath: /etc/kubernetes
                name: "etc-kubernetes"
              - mountPath: /etc/ssl/certs
                name: "ssl-certs"
              - mountPath: /usr
                name: "usr"
              - mountPath: /lib64
                name: "lib64"